# ✅ Django 交通號誌資料庫系統

## 🎯 系統功能

✅ **資料庫 Models**

- Group 模型：批次資料主表
- Intersection 模型：路口明細表
- 包含完整的欄位驗證和中文顯示

✅ **Django Admin 管理介面**

- 完整的資料管理功能
- 支援搜尋、篩選、分頁
- 內嵌編輯功能

✅ **API 端點**

- `POST /api/predict/`: 接收資料並預測
- `GET /api/data/`: 查詢已儲存的資料

✅ **資料驗證工具**

- TrafficDataValidator: 資料驗證功能

## 🚀 使用方式

### 1. 啟動開發伺服器

```bash
cd "d:\01.Project\traffic\traffic_project\backend\traffic_env\traffic"
D:/01.Project/traffic/traffic_project/backend/traffic_env/Scripts/python.exe manage.py runserver
```

### 2. 訪問管理介面

- 網址：http://localhost:8000/admin
- 需要先建立超級使用者：

```bash
D:/01.Project/traffic/traffic_project/backend/traffic_env/Scripts/python.exe manage.py createsuperuser
```

### 3. API 端點

- 預測 API：`POST http://localhost:8000/api/predict/`
- 查詢 API：`GET http://localhost:8000/api/data/`

## 📊 API 使用說明

### 預測 API (POST /api/predict/)

**請求格式：**

```json
[
	{
		"VD_ID": "VLRJX20",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 0,
		"LaneType": 1,
		"Speed": 34,
		"Occupancy": 25,
		"Volume_M": 5,
		"Speed_M": 41,
		"Volume_S": 2,
		"Speed_S": 36,
		"Volume_L": 5,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	},
	{
		"VD_ID": "VLRJM60",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 1,
		"LaneType": 1,
		"Speed": 38,
		"Occupancy": 20,
		"Volume_M": 5,
		"Speed_M": 41,
		"Volume_S": 2,
		"Speed_S": 36,
		"Volume_L": 1,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	},
	{
		"VD_ID": "VLRJX00",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 2,
		"LaneType": 1,
		"Speed": 37,
		"Occupancy": 25,
		"Volume_M": 5,
		"Speed_M": 41,
		"Volume_S": 5,
		"Speed_S": 36,
		"Volume_L": 1,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	},
	{
		"VD_ID": "VLRJX00",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 3,
		"LaneType": 1,
		"Speed": 33,
		"Occupancy": 20,
		"Volume_M": 3,
		"Speed_M": 41,
		"Volume_S": 2,
		"Speed_S": 36,
		"Volume_L": 5,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	}
]
```

**回應格式：**

```json
{
	"group_id": "550e8400-e29b-41d4-a716-446655440000",
	"east_west_seconds": 75,
	"south_north_seconds": 65,
	"timestamp": "2025-09-13T12:00:00Z",
	"message": "資料已成功儲存並完成預測"
}
```

### 查詢 API (GET /api/data/)

**查詢所有批次：**

```
GET /api/data/?limit=10
```

**查詢特定批次：**

```
GET /api/data/?group_id=550e8400-e29b-41d4-a716-446655440000
```

## 📊 資料表結構

### Group（資料組主表）

| 欄位名稱            | 資料型態      | 描述                                     |
| ------------------- | ------------- | ---------------------------------------- |
| id                  | BigAutoField  | 主鍵，自動生成的唯一識別碼               |
| group_id            | UUIDField     | 批次唯一識別碼，一組四路口資料歸為同一批 |
| timestamp           | DateTimeField | 資料接收或預測時間                       |
| east_west_seconds   | IntegerField  | 模型預測的東西向最大綠燈秒數             |
| south_north_seconds | IntegerField  | 模型預測的南北向最大綠燈秒數             |

### Intersection（路口明細表）

| 欄位名稱   | 資料型態      | 描述                         |
| ---------- | ------------- | ---------------------------- |
| id         | BigAutoField  | 主鍵，自動生成               |
| group      | ForeignKey    | 關聯到 Group 表的 group_id   |
| VD_ID      | CharField     | 路口偵測器 ID（有選擇限制）  |
| DayOfWeek  | IntegerField  | 星期 (1=星期一 ... 7=星期日) |
| Hour       | IntegerField  | 時 (0-23)                    |
| Minute     | IntegerField  | 分 (0-59)                    |
| Second     | IntegerField  | 秒 (0-59)                    |
| IsPeakHour | BooleanField  | 是否尖峰時段                 |
| LaneID     | IntegerField  | 車道編號                     |
| LaneType   | IntegerField  | 車道類型                     |
| Speed      | FloatField    | 平均速率                     |
| Occupancy  | FloatField    | 車道佔有率                   |
| Volume_M   | IntegerField  | 中型車流量                   |
| Speed_M    | FloatField    | 中型車速率                   |
| Volume_S   | IntegerField  | 小型車流量                   |
| Speed_S    | FloatField    | 小型車速率                   |
| Volume_L   | IntegerField  | 大型車流量                   |
| Speed_L    | FloatField    | 大型車速率                   |
| Volume_T   | IntegerField  | 特種車流量（預設 0）         |
| Speed_T    | FloatField    | 特種車速率（預設 0.0）       |
| created_at | DateTimeField | 建立時間                     |

## 🔧 VD_ID 說明

路口偵測器 ID，只有三支：

- **VLRJX20**: 往東
- **VLRJM60**: 往西
- **VLRJX00**: 往南、往北

## 🔍 資料庫檔案位置

SQLite 資料庫檔案：`d:\01.Project\traffic\traffic_project\backend\traffic_env\traffic\db.sqlite3`

---

**✨ 系統已完成，可以與前端進行資料串接！**

---

# 提供前端傳送的四個路口資料格式

VD_ID: 路口偵測器 ID，只有三支

- VLRJX20 為往東
- VLRJM60 為往西
- VLRJX00 為往南、往北

```json
[
	{
		"VD_ID": "VLRJX20",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 0,
		"LaneType": 1,
		"Speed": 34,
		"Occupancy": 25,
		"Volume_M": 5,
		"Speed_M": 41,
		"Volume_S": 2,
		"Speed_S": 36,
		"Volume_L": 5,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	},
	{
		"VD_ID": "VLRJM60",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 1,
		"LaneType": 1,
		"Speed": 38,
		"Occupancy": 20,
		"Volume_M": 5,
		"Speed_M": 41,
		"Volume_S": 2,
		"Speed_S": 36,
		"Volume_L": 1,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	},
	{
		"VD_ID": "VLRJX00",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 2,
		"LaneType": 1,
		"Speed": 37,
		"Occupancy": 25,
		"Volume_M": 5,
		"Speed_M": 41,
		"Volume_S": 5,
		"Speed_S": 36,
		"Volume_L": 1,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	},
	{
		"VD_ID": "VLRJX00",
		"DayOfWeek": 6,
		"Hour": 19,
		"Minute": 41,
		"Second": 2,
		"IsPeakHour": 1,
		"LaneID": 3,
		"LaneType": 1,
		"Speed": 33,
		"Occupancy": 20,
		"Volume_M": 3,
		"Speed_M": 41,
		"Volume_S": 2,
		"Speed_S": 36,
		"Volume_L": 5,
		"Speed_L": 27,
		"Volume_T": 0,
		"Speed_T": 0
	}
]
```

---

# ✅ 已完成實作的 Django 資料庫系統

## 🎯 系統完成狀態

✅ **資料庫 Models 已建立完成**

- Group 模型：批次資料主表
- Intersection 模型：路口明細表
- 包含完整的欄位驗證和中文顯示

✅ **Django Admin 管理介面已配置**

- 完整的資料管理功能
- 支援搜尋、篩選、分頁
- 內嵌編輯功能

✅ **API 端點已實作**

- `/api/predict/`: 接收資料並預測
- `/api/data/`: 查詢已儲存的資料

✅ **資料處理工具已建立**

- TrafficDataManager: 資料管理工具類別
- TrafficDataValidator: 資料驗證工具

✅ **測試工具已提供**

- Django management command
- API 測試腳本

## 🚀 快速開始

### 1. 啟動開發伺服器

```bash
cd "d:\01.Project\traffic\traffic_project\backend\traffic_env\traffic"
D:/01.Project/traffic/traffic_project/backend/traffic_env/Scripts/python.exe manage.py runserver
```

### 2. 訪問管理介面

- 網址：http://localhost:8000/admin
- 需要先建立超級使用者：

```bash
D:/01.Project/traffic/traffic_project/backend/traffic_env/Scripts/python.exe manage.py createsuperuser
```

### 3. 測試 API 功能

- 預測 API：http://localhost:8000/api/predict/
- 查詢 API：http://localhost:8000/api/data/

### 4. 建立測試資料

```bash
D:/01.Project/traffic/traffic_project/backend/traffic_env/Scripts/python.exe manage.py test_traffic_data --create-sample --show-stats
```

## 📊 資料表結構詳細說明

### Group（資料組主表）

| 欄位名稱            | 資料型態      | 描述                                     |
| ------------------- | ------------- | ---------------------------------------- |
| id                  | BigAutoField  | 主鍵，自動生成的唯一識別碼               |
| group_id            | UUIDField     | 批次唯一識別碼，一組四路口資料歸為同一批 |
| timestamp           | DateTimeField | 資料接收或預測時間                       |
| east_west_seconds   | IntegerField  | 模型預測的東西向最大綠燈秒數             |
| south_north_seconds | IntegerField  | 模型預測的南北向最大綠燈秒數             |

### Intersection（路口明細表）

| 欄位名稱   | 資料型態      | 描述                         |
| ---------- | ------------- | ---------------------------- |
| id         | BigAutoField  | 主鍵，自動生成               |
| group      | ForeignKey    | 關聯到 Group 表的 group_id   |
| VD_ID      | CharField     | 路口偵測器 ID（有選擇限制）  |
| DayOfWeek  | IntegerField  | 星期 (1=星期一 ... 7=星期日) |
| Hour       | IntegerField  | 時 (0-23)                    |
| Minute     | IntegerField  | 分 (0-59)                    |
| Second     | IntegerField  | 秒 (0-59)                    |
| IsPeakHour | BooleanField  | 是否尖峰時段                 |
| LaneID     | IntegerField  | 車道編號                     |
| LaneType   | IntegerField  | 車道類型                     |
| Speed      | FloatField    | 平均速率                     |
| Occupancy  | FloatField    | 車道佔有率                   |
| Volume_M   | IntegerField  | 中型車流量                   |
| Speed_M    | FloatField    | 中型車速率                   |
| Volume_S   | IntegerField  | 小型車流量                   |
| Speed_S    | FloatField    | 小型車速率                   |
| Volume_L   | IntegerField  | 大型車流量                   |
| Speed_L    | FloatField    | 大型車速率                   |
| Volume_T   | IntegerField  | 特種車流量（預設 0）         |
| Speed_T    | FloatField    | 特種車速率（預設 0.0）       |
| created_at | DateTimeField | 建立時間                     |

## 🔧 特色功能

### 1. 自動產生批次 ID

- 每次 API 呼叫自動產生唯一的 UUID
- 方便追蹤和查詢特定批次的資料

### 2. 資料驗證

- 完整的欄位驗證機制
- 支援 VD_ID 選擇限制
- 時間和數值範圍檢查

### 3. 中文化介面

- Django Admin 完全中文化
- 欄位說明和錯誤訊息都有中文顯示

### 4. 關聯查詢

- Group 和 Intersection 之間有完整的外鍵關聯
- 支援反向查詢和聚合統計

### 5. 便利的屬性方法

- `get_direction_display`: 取得方向中文顯示
- `total_volume`: 計算總車流量

## 📖 程式化操作範例

### 建立資料

```python
from traffic_signal.data_utils import TrafficDataManager

# 建立一批交通資料
group = TrafficDataManager.create_traffic_batch(
    traffic_data,  # 四筆路口資料的列表
    east_west_seconds=75,
    south_north_seconds=65
)
```

### 查詢資料

```python
# 查詢特定批次
batch_data = TrafficDataManager.get_traffic_batch(str(group.group_id))

# 取得最近的批次
recent_batches = TrafficDataManager.get_recent_batches(limit=10)

# 統計資訊
stats = TrafficDataManager.get_statistics()
```

### 資料驗證

```python
from traffic_signal.data_utils import TrafficDataValidator

# 驗證整批資料
errors = TrafficDataValidator.validate_batch_data(traffic_data)
if errors:
    print("驗證失敗:", errors)
```

---

## 📁 相關檔案

- `models.py`: Django 資料模型定義
- `admin.py`: Django Admin 管理介面配置
- `views.py`: API 視圖實作
- `data_utils.py`: 資料處理工具類別
- `test_traffic_data.py`: Django management command
- `test_api.py`: API 測試腳本
- `README_database.md`: 詳細說明文件

## 🔍 資料庫檔案位置

SQLite 資料庫檔案：`d:\01.Project\traffic\traffic_project\backend\traffic_env\traffic\db.sqlite3`

可使用 DB Browser for SQLite 等工具直接查看資料庫內容。

---

**✨ 系統已完全實作完成，可以立即投入使用！**

---

# SQLite 資料庫設計文件（Django 適用）

## 1. 資料組主表（Group）

| 欄位名稱            | 資料型態       | 描述                                     |
| ------------------- | -------------- | ---------------------------------------- |
| id                  | 整數，自動主鍵 | 主鍵，自動生成的唯一識別碼               |
| group_id            | UUID 字串      | 批次唯一識別碼，一組四路口資料歸為同一批 |
| timestamp           | DateTime       | 資料接收或預測時間                       |
| east_west_seconds   | 整數           | 模型預測的東西向最大綠燈秒數             |
| south_north_seconds | 整數           | 模型預測的南北向最大綠燈秒數             |

- 此表用以儲存一次前端批次送來的四路口資料的「整體批次」資訊。
- group_id 為每批資料的唯一識別，方便前端視覺化及後續資料查詢。

---

## 2. 路口明細表（Intersection）

| 欄位名稱   | 資料型態       | 描述                         |
| ---------- | -------------- | ---------------------------- |
| id         | 整數，自動主鍵 | 主鍵，自動生成               |
| group      | ForeignKey     | 關聯到 Group 表的 group_id   |
| VD_ID      | 字串           | 路口偵測器 ID                |
| DayOfWeek  | 整數           | 星期 (1=星期一 ... 7=星期日) |
| Hour       | 整數           | 時                           |
| Minute     | 整數           | 分                           |
| Second     | 整數           | 秒                           |
| IsPeakHour | 布林           | 是否尖峰時段                 |
| LaneID     | 整數           | 車道編號                     |
| LaneType   | 整數           | 車道類型                     |
| Speed      | 浮點數         | 平均速率                     |
| Occupancy  | 浮點數         | 車道佔有率                   |
| Volume_M   | 整數           | 中型車流量                   |
| Speed_M    | 浮點數         | 中型車速率                   |
| Volume_S   | 整數           | 小型車流量                   |
| Speed_S    | 浮點數         | 小型車速率                   |
| Volume_L   | 整數           | 大型車流量                   |
| Speed_L    | 浮點數         | 大型車速率                   |
| Volume_T   | 整數           | 特種車流量（可選）           |
| Speed_T    | 浮點數         | 特種車速率（可選）           |

---

在 Django 中，存入的資料庫資料可透過以下方式查詢與管理：

## 1. Django Admin 管理介面

- 啟用 Django 內建的 Admin 功能，對應的 Model 會自動有資料管理頁面。
- 透過瀏覽器訪問 `/admin`（如 http://localhost:8000/admin）登入後，即可瀏覽、搜尋、編輯、刪除資料。
- 需先於 `admin.py` 註冊你的 Model，例如：

  ```python
  from django.contrib import admin
  from .models import Group, Intersection

  admin.site.register(Group)
  admin.site.register(Intersection)
  ```

## 2. Django shell (互動命令列)

- 可以透過命令 `python manage.py shell` 進入互動模式查詢。
- 例如查詢所有 Group：
  ```python
  from yourapp.models import Group
  groups = Group.objects.all()
  print(groups)
  ```
- 查詢特定 group 相關的路口明細：
  ```python
  group = Group.objects.first()
  intersections = group.intersections.all()
  print(intersections)
  ```

## 3. 在 Django 視圖中操作

- 使用 Django ORM 在 view、API 或命令中查詢，如：

  ```python
  from yourapp.models import Group

  def view_function(request):
      data = Group.objects.filter(id=1)
      # 傳給模板或回傳 json
  ```

## 資料庫實際檔案位置（SQLite）

- SQLite 的資料庫檔案預設為 `db.sqlite3`，位於 Django 專案根目錄中（與 manage.py 同級）
- 可用任何 SQLite 工具（如 DB Browser for SQLite）打開此檔案查看與編輯資料。

---

總結：

- 在瀏覽器用 Django Admin 介面最直覺。
- 開發者可用 Django shell 或 ORM 自訂查詢。
- SQLite 檔案位於專案目錄下的 `db.sqlite3`，可用通用工具管理。
